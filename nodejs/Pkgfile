# Description:	JavaScript runtime built on V8 engine - current version
# URL:		http://nodejs.org/
# Maintainer:	sajcho, saux dot aarch64 at gmail dot com
# Depends on:	brotli c-ares icu

name=nodejs
version=20.8.0
release=1
source=(https://nodejs.org/dist/v${version}/node-v${version}.tar.xz)

build() {
	cd node-v${version}

	# fix - python version
	sed -e "s|3.11|3.12|g" -e "s|3, 11|3, 12|g" -i configure

	# Use -flto=auto to use GNU makeâ€™s job server, if available,
	# or otherwise fall back to autodetection of the number
	# of CPU threads present in your system.
	sed "s|lto=4|lto=auto|" -i common.gypi

	export CFLAGS="${CFLAGS/ -flto=auto -ffat-lto-objects/ -w}"
	export CXXFLAGS="${CXXFLAGS/ -flto=auto -ffat-lto-objects/ -w}"

	./configure \
		--prefix=/usr \
		--enable-lto \
		--shared-cares \
		--shared-brotli \
		--shared-libuv \
		--shared-nghttp2 \
		--shared-openssl \
		--shared-zlib \
		--with-intl=system-icu \
		--without-npm

	make -C out BUILDTYPE=Release V=1

	make DESTDIR=$PKG install

	rm -r $PKG/usr/share/doc

	# clean up
	find $PKG -type f \( \
		-name '*.md' -o \
		-name 'TODO.org' -o \
		-name 'ChangeLog' -o \
		-name 'NEWS' \) -delete
}
