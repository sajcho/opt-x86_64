# Description:	Fast CPU emulator and virtualizer for all supported platforms
# URL:		http://www.qemu-project.org/
# Maintainer:	sajcho, saux dot aarch64 at gmail dot com
# Depends on:	attr

name=qemu-static
_realname=qemu
version=9.0.2
release=1
source=(https://download.qemu.org/${_realname}-${version}.tar.xz \
	static-linux-user-stubs.diff)

build() {
	cd ${_realname}-${version}

	patch -p1 -i $SRC/static-linux-user-stubs.diff

	export CFLAGS="${CFLAGS/ -flto=auto -ffat-lto-objects/ -fno-lto}"
	export CXXFLAGS="${CXXFLAGS/ -flto=auto -ffat-lto-objects/ -fno-lto}"

	_targets="aarch64-linux-user,loongarch64-linux-user,riscv64-linux-user,x86_64-linux-user"

	mkdir -p build-static
	cd build-static

	../configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--libexecdir=/usr/lib/qemu \
		--enable-linux-user \
		--enable-attr \
		--disable-lto \
		--disable-pie \
		--enable-tcg \
		--disable-system \
		--disable-bpf \
		--disable-bsd-user \
		--disable-capstone \
		--disable-containers \
		--disable-docs \
		--disable-download \
		--disable-fdt \
		--disable-fuse \
		--disable-gcrypt \
		--disable-glusterfs \
		--disable-gnutls \
		--disable-gtk \
		--disable-install-blobs \
		--disable-kvm \
		--disable-libiscsi \
		--disable-libnfs \
		--disable-libssh \
		--disable-linux-io-uring \
		--disable-nettle \
		--disable-opengl \
		--disable-qom-cast-debug \
		--disable-relocatable \
		--disable-sdl \
		--disable-strip \
		--disable-tools \
		--disable-tpm \
		--disable-vde \
		--disable-vhost-crypto \
		--disable-vhost-kernel \
		--disable-vhost-net \
		--disable-vhost-user \
		--disable-vnc \
		--disable-werror \
		--disable-xkbcommon \
		--disable-xen \
		--disable-zstd \
		--target-list=${_targets} \
		--static

	make V=1

	make DESTDIR=$PKG install

	cp $SRC/${_realname}-${version}/scripts/qemu-binfmt-conf.sh \
		$PKG/usr/share/qemu

	# rename static binaries to prevent name conflicts
	for _src in "$PKG/usr/bin/qemu-"*; do
		mv -v "$_src" "$PKG/usr/bin/$(basename "$_src")-static"
	done

	# they conflict with qemu
	rm $PKG/usr/share/qemu/trace-events-all
}
